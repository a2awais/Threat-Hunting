DeviceProcessEvents
| where 
    (InitiatingProcessFileName == @"powershell.exe" and 
     (ProcessCommandLine contains "iwr https://2fa-bns.com/" or 
      ProcessCommandLine contains "Start-BitsTransfer -Source 'https://2fa-bns.com/" or 
      ProcessCommandLine contains "Set-MpPreference -DisableRealtimeMonitoring" or 
      ProcessCommandLine contains "Add-MpPreference -ExclusionPath" or 
      ProcessCommandLine contains "Add-MpPreference -ExclusionExtension" or 
      ProcessCommandLine contains "start https://admin.booking.com" or 
      ProcessCommandLine contains "gci C:\\ -filter msbuild.exe")) 
    or 
    (FileName == @"msbuild.exe" and ProcessCommandLine contains "v.proj" and FolderPath contains "ProgramData") 
    or 
    (FileName in~ ("staxs.exe", "tybd7.exe", "Wwigu.exe") and (FolderPath contains "ProgramData" or FolderPath contains "Temp")) 
    or 
    (FileName == @"aspnet_compiler.exe" and InitiatingProcessFileName in~ ("staxs.exe", "tybd7.exe"))
| project Timestamp, DeviceName, FileName, FolderPath, ProcessCommandLine, InitiatingProcessFileName, SHA256
| union (
    DeviceNetworkEvents
    | where 
        (RemoteUrl contains "low-house.com" or 
         RemoteUrl contains "oncameraworkout.com" or 
         RemoteUrl contains "2fa-bns.com" or 
         RemoteUrl contains "asj77.com" or 
         RemoteUrl contains "asj88.com" or 
         RemoteUrl contains "asj99.com" or 
         RemoteUrl contains "wmk77.com" or 
         RemoteUrl contains "8eh18dhq9wd.click") 
        or 
        (RemoteIP in~ ("194.169.163.140", "193.221.200.233", "13.223.25.84") and RemotePort == 3535)
    | project Timestamp, DeviceName, RemoteUrl, RemoteIP, RemotePort, InitiatingProcessFileName
)
| union (
    DeviceFileEvents
    | where 
        (FileName =~ "v.proj" and FolderPath contains "ProgramData") or 
        (FileName in~ ("staxs.exe", "tybd7.exe", "Wwigu.exe", "Lbpyjxefa.dll") and (FolderPath contains "ProgramData" or FolderPath contains "Temp")) or 
        (FileName in~ ("DeleteApp.url", "update.lnk") and (FolderPath contains "Startup")) or 
        (FileName == @"pins.dat" and FolderPath contains "ProgramData") or 
        SHA256 in~ ("cd3604fb9fe210261de11921ff1bea0a7bf948ad477d063e17863cede1fadc41", "bf374d8e2a37ff28b4dc9338b45bbf396b8bf088449d05f00aba3c39c54a3731", "91696f9b909c479be23440a9e4072dd8c11716f2ad3241607b542b202ab831ce")
    | project Timestamp, DeviceName, FileName, FolderPath, SHA256, InitiatingProcessFileName
)

| order by Timestamp desc
